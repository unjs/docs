<script setup lang="ts">
import { withoutTrailingSlash } from 'ufo'

definePageMeta({
  layout: 'docs',
})

const appConfig = useAppConfig()
const route = useRoute()

const { data: page } = await useAsyncData(route.path, () => queryContent(route.path).findOne())

if (!page.value) {
  showError({
    statusCode: 404,
    statusMessage: `Page not found: ${route.path}`,
  })
}

const { data: surround } = await useAsyncData(`${route.path}-surround`, () =>
  queryContent()
    .where({ _extension: 'md', navigation: { $ne: false } })
    .only(['title', 'description', '_path'])
    .findSurround(withoutTrailingSlash(route.path)),
)

useSeoMeta({
  title: page.value?.title,
  description: page.value?.description,
})

if (process.server) {
  // @ts-ignore
  useSchemaOrg([
    // @ts-ignore
    defineArticle({
      '@type': 'TechArticle',
    }),
  ])
}

if (process.server) {
  // @ts-ignore
  defineOgImageComponent('OgImageDocs')
}

const headline = computed(() => findPageHeadline(page.value))

const tocOpen = ref(false)
const tocLinks = computed(() =>
  (page.value.body?.toc?.links || []).map((link) => ({
    label: link.text,
    href: `#${link.id}`,
  })),
)
</script>

<template>
  <UPage v-if="page">
    <UPageHeader :title="page.title" :description="page.description" :links="page.links" :headline="headline">
    </UPageHeader>

    <UDropdown
      v-if="tocLinks.length > 2"
      :items="[/*[{ label: 'Return to top', href: '#' }] TODO: once sticky */ tocLinks]"
      v-model:open="tocOpen"
      class="mt-4"
    >
      <UButton
        color="white"
        label="On this page"
        :trailing-icon="`i-heroicons-chevron-${tocOpen ? 'down' : 'right'}-20-solid`"
      />
    </UDropdown>

    <UPageBody prose>
      <ContentRenderer v-if="page.body" :value="page" />

      <div class="space-y-6">
        <UDivider type="dashed" />
        <div class="mb-4">
          <UPageLinks
            class="inline-block"
            :links="[
              {
                icon: 'i-ph-pen-duotone',
                label: 'Edit this page on GitHub',
                to: `https://github.com/${appConfig.docs.github}/edit/main/docs/${page._file}`,
                target: '_blank',
              },
            ]"
          />
        </div>
        <UContentSurround v-if="surround?.length" class="mb-4" :surround="surround" />
      </div>
    </UPageBody>
  </UPage>
</template>
